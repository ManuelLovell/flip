import{C as a,O as t}from"./constants-6b42fd96.js";function D(s,m){const I=window.matchMedia("(prefers-color-scheme: dark)"),y=I.matches?"dark":"light",h=I.matches?"light":"dark";for(var T=0;T<m.styleSheets.length;T++)for(var E=0;E<m.styleSheets[T].cssRules.length;E++){let d=m.styleSheets[T].cssRules[E];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(s.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${y})`),d.media.mediaText.includes(h)&&d.media.deleteMedium(`(prefers-color-scheme: ${h})`)):s.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${h})`),d.media.mediaText.includes(y)&&d.media.deleteMedium(`(prefers-color-scheme: ${y})`)))}}function _(){const s=document.createElement("img");s.id="whatsNewButton",s.setAttribute("class","icon"),s.classList.add("clickable"),s.setAttribute("title","Whats New?"),s.setAttribute("src","/info.svg"),s.onclick=async function(){try{localStorage.setItem(a.VERSION,"true"),s.classList.remove("whats-new-shine")}catch{}await t.modal.open({id:a.EXTENSIONWHATSNEW,url:"/bsWhatsNew.html",height:500,width:350})};try{localStorage.getItem(a.VERSION)!=="true"&&s.classList.add("whats-new-shine")}catch{}return s}document.querySelector("#app").innerHTML=`
  <div>
    <div style="display:flex;"><div id="bannerText"></div><div id="whatsNew"></div></div>
    <h4>Disable Z-Ordering:<input type="checkbox" id="disableZOrder"></h4>
    <h4>Disable Binding for Players:<input type="checkbox" id="disableBinding"></h4>
    <h4>Keep Attachments with Parent:<input type="checkbox" id="keepAttachments"></h4>
  </div>
`;const k=["New Attachment Permission","Flip! v1.21","Fixed Bug with Player Flip!!"];let O=0;const w=document.getElementById("bannerText"),R=document.getElementById("disableZOrder"),X=document.getElementById("disableBinding"),x=document.getElementById("keepAttachments"),B=document.getElementById("whatsNew");B.appendChild(_());function P(){w.style.opacity="0",setTimeout(()=>{$()},2e3)}function $(){O=(O+1)%k.length,w.textContent=k[O],w.style.opacity="1",setTimeout(()=>{P()},1e4)}w.textContent=k[O];$();t.onReady(async()=>{const s=await t.theme.getTheme(),m=await t.room.getMetadata();let I=m[`${a.EXTENSIONID}/disableZIndex`]==!0,y=m[`${a.EXTENSIONID}/disableBinding`]==!0,h=m[`${a.EXTENSIONID}/attachmentParent`]==!0;D(s,document),t.theme.onChange(e=>{D(e,document)}),await t.player.getRole()=="GM"?(X.checked=y,R.checked=I,x.checked=h,await t.scene.isReady()&&await d(),await t.scene.onReadyChange(async o=>{o&&await d()})):(await t.action.setHeight(50),document.querySelector("#app").innerHTML="Configuration is GM-Access only.",t.room.onMetadataChange(async e=>{I=e[`${a.EXTENSIONID}/disableZIndex`]==!0,y=e[`${a.EXTENSIONID}/disableBinding`]==!0,h=e[`${a.EXTENSIONID}/attachmentParent`]==!0,y&&await t.contextMenu.remove(a.CONTEXTBINDID),y===!1&&await E()})),await t.contextMenu.create({id:a.CONTEXTFLIPID,icons:[{icon:"/flip.svg",label:"Flip It",filter:{every:[{key:"image",value:void 0,operator:"!="}]}}],async onClick(e,o){await t.scene.items.updateItems(e.items,i=>{for(let n of i)n.scale.x=-n.scale.x})}}),await t.contextMenu.create({id:a.CONTEXTFLOPID,icons:[{icon:"/flop.svg",label:"Flip It!!",filter:{every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,operator:"!=",coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}}],async onClick(e,o){let i=[],n=[],p=[];await t.player.deselect(e.items.map(r=>r.id));const g=(await t.scene.items.getItemAttachments(e.items.map(r=>r.id))).filter(r=>!e.items.find(c=>c.id==r.id));for(let r of e.items){const c=r,l=JSON.parse(c.metadata[`${a.EXTENSIONID}/metadata_bind`]);if(h){const u=(await t.scene.items.getItemAttachments([r.id]))?.filter(f=>f.id!==r.id);u?.length>0&&(r.metadata[`${a.EXTENSIONID}/metadata_bind_attachments`]=JSON.stringify(u),n=n.concat(u));const v=l.metadata[`${a.EXTENSIONID}/metadata_bind_attachments`];if(v){const f=c.position.x-l.position.x,M=c.position.y-l.position.y,b=JSON.parse(v);for(const S of b)S.position.x+=f,S.position.y+=M;i=i.concat(b)}}else for(let u of g)if(e.items.find(f=>f.id===u.attachedTo)){const f={...u};f.attachedTo=l.id,p.push(f)}l.position.x=c.position.x,l.position.y=c.position.y,c.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0,l.metadata[`${a.EXTENSIONID}/metadata_bind`]=JSON.stringify(c),i.push(l),n.push(r)}await t.scene.items.addItems(i),h||await t.scene.items.updateItems(g,r=>{for(let c of r){const l=p.find(u=>u.id===c.id);l&&(c.attachedTo=l.attachedTo)}}),await t.scene.items.deleteItems(n.map(r=>r.id));const A=i.map(r=>r.id);await t.player.select(A)}});async function E(){await t.contextMenu.create({id:a.CONTEXTBINDID,icons:[{icon:"/combine.svg",label:"Bind It",filter:{min:2,max:2,every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}},{icon:"/split.svg",label:"UnBind It",filter:{max:1,every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,operator:"!=",coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}}],async onClick(e,o){if(e.items.length==1){const i=e.items[0],n=JSON.parse(i.metadata[`${a.EXTENSIONID}/metadata_bind`]);n.position.x=i.position.x+i.image.width/2,n.position.y=i.position.y+i.image.height/4,n.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0,await t.scene.items.updateItems(p=>p.id===i.id,p=>{for(let N of p)N.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0}),await t.scene.items.addItems([n])}else{if(!e.items.every(N=>N.layer===e.items[0].layer)){await t.notification.show("Bound items must be from the same Layer.","WARNING");return}const n=e.items[0],p=e.items[1];await t.scene.items.updateItems([e.items[0]],N=>{for(let g=0;g<N.length;g++)N[g].metadata[`${a.EXTENSIONID}/metadata_bind`]=JSON.stringify(p)}),await t.scene.items.deleteItems([p.id]),await t.player.select([n.id])}}})}await E();async function d(){R.onclick=async e=>{const o=e.target;I=!I,await t.room.setMetadata({[`${a.EXTENSIONID}/disableZIndex`]:o.checked})},X.onclick=async e=>{const o=e.target;y=!y,await t.room.setMetadata({[`${a.EXTENSIONID}/disableBinding`]:o.checked})},x.onclick=async e=>{const o=e.target;h=!h,await t.room.setMetadata({[`${a.EXTENSIONID}/attachmentParent`]:o.checked})},await t.scene.items.onChange(async e=>{await t.scene.items.updateItems(e,o=>{if(!I)for(let i of o){if(i.type!=="IMAGE")continue;const n=i.position.y*1e3+i.image.height/6;(i.zIndex!==n&&i.metadata[`${a.EXTENSIONID}/metadata_flip`]!==void 0||i.metadata[`${a.EXTENSIONID}/metadata_flip`]===void 0)&&(i.metadata[`${a.EXTENSIONID}/metadata_flip`]={anchor:n},i.zIndex=n)}})}),await t.scene.items.updateItems(e=>e.layer==="CHARACTER"||e.layer==="MOUNT",e=>{C(e)})}async function C(e){for(let o of e){if(o.type!=="IMAGE")continue;if(o.metadata[`${a.EXTENSIONID}/metadata_flip`]===void 0){const n=o.position.y*1e3+o.image.height/6;o.metadata[`${a.EXTENSIONID}/metadata_flip`]={anchor:n}}const i=o.metadata[`${a.EXTENSIONID}/metadata_flip`];o.zIndex=i.anchor}return e}});
