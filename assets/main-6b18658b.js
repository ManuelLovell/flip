import{C as a,O as t}from"./constants-d6b9b9e8.js";function S(){let s=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,I=>{const d=(s+Math.random()*16)%16|0;return s=Math.floor(s/16),(I==="x"?d:d&3|8).toString(16)})}function X(s,y){const I=window.matchMedia("(prefers-color-scheme: dark)"),d=I.matches?"dark":"light",h=I.matches?"light":"dark";for(var O=0;O<y.styleSheets.length;O++)for(var E=0;E<y.styleSheets[O].cssRules.length;E++){let l=y.styleSheets[O].cssRules[E];l&&l.media&&l.media.mediaText.includes("prefers-color-scheme")&&(s.mode=="LIGHT"?(l.media.appendMedium(`(prefers-color-scheme: ${d})`),l.media.mediaText.includes(h)&&l.media.deleteMedium(`(prefers-color-scheme: ${h})`)):s.mode=="DARK"&&(l.media.appendMedium(`(prefers-color-scheme: ${h})`),l.media.mediaText.includes(d)&&l.media.deleteMedium(`(prefers-color-scheme: ${d})`)))}}function L(){const s=document.createElement("img");s.id="whatsNewButton",s.setAttribute("class","icon"),s.classList.add("clickable"),s.setAttribute("title","Whats New?"),s.setAttribute("src","/info.svg"),s.onclick=async function(){try{localStorage.setItem(a.VERSION,"true"),s.classList.remove("whats-new-shine")}catch{}await t.modal.open({id:a.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(a.VERSION)!=="true"&&s.classList.add("whats-new-shine")}catch{}return s}document.querySelector("#app").innerHTML=`
  <div>
    <div style="display:flex;"><div id="bannerText"></div><div id="whatsNew"></div></div>
    <h4>Disable Z-Ordering:<input type="checkbox" id="disableZOrder"></h4>
    <h4>Disable Binding for Players:<input type="checkbox" id="disableBinding"></h4>
    <h4>Keep Attachments with Parent:<input type="checkbox" id="keepAttachments"></h4>
  </div>
`;const b=["New Attachment Permission","Flip! v1.21","Fixed Bug with Player Flip!!"];let x=0;const v=document.getElementById("bannerText"),$=document.getElementById("disableZOrder"),C=document.getElementById("disableBinding"),M=document.getElementById("keepAttachments"),F=document.getElementById("whatsNew");F.appendChild(L());function U(){v.style.opacity="0",setTimeout(()=>{A()},2e3)}function A(){x=(x+1)%b.length,v.textContent=b[x],v.style.opacity="1",setTimeout(()=>{U()},1e4)}v.textContent=b[x];A();t.onReady(async()=>{const s=await t.theme.getTheme(),y=await t.room.getMetadata();let I=y[`${a.EXTENSIONID}/disableZIndex`]==!0,d=y[`${a.EXTENSIONID}/disableBinding`]==!0,h=y[`${a.EXTENSIONID}/attachmentParent`]==!0;X(s,document),t.theme.onChange(e=>{X(e,document)}),await t.player.getRole()=="GM"?(C.checked=d,$.checked=I,M.checked=h,await t.scene.isReady()&&await l(),await t.scene.onReadyChange(async o=>{o&&await l()})):(await t.action.setHeight(50),document.querySelector("#app").innerHTML="Configuration is GM-Access only.",t.room.onMetadataChange(async e=>{I=e[`${a.EXTENSIONID}/disableZIndex`]==!0,d=e[`${a.EXTENSIONID}/disableBinding`]==!0,h=e[`${a.EXTENSIONID}/attachmentParent`]==!0,d&&await t.contextMenu.remove(a.CONTEXTBINDID),d===!1&&await E()})),await t.contextMenu.create({id:a.CONTEXTFLIPID,icons:[{icon:"/flip.svg",label:"Reverse It",filter:{every:[{key:"image",value:void 0,operator:"!="}]}}],async onClick(e,o){await t.scene.items.updateItems(e.items,i=>{for(let n of i)n.scale.x=-n.scale.x})}}),await t.contextMenu.create({id:a.CONTEXTFLOPID,icons:[{icon:"/flop.svg",label:"Flip It!",filter:{every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,operator:"!=",coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}}],async onClick(e,o){let i=[],n=[],p=[];await t.player.deselect(e.items.map(r=>r.id));const g=(await t.scene.items.getItemAttachments(e.items.map(r=>r.id))).filter(r=>!e.items.find(m=>m.id==r.id)),B=(await t.scene.items.getItems()).map(r=>r.id);for(let r of e.items){const m=r,c=JSON.parse(m.metadata[`${a.EXTENSIONID}/metadata_bind`]),N=B.includes(c.id)?S():void 0;if(N&&(c.id=N),h){const T=(await t.scene.items.getItemAttachments([r.id]))?.filter(u=>u.id!==r.id);T?.length>0&&(r.metadata[`${a.EXTENSIONID}/metadata_bind_attachments`]=JSON.stringify(T),n=n.concat(T));const k=c.metadata[`${a.EXTENSIONID}/metadata_bind_attachments`];if(k){const u=m.position.x-c.position.x,G=m.position.y-c.position.y,R=JSON.parse(k);for(const w of R)w.position.x+=u,w.position.y+=G,N&&(w.id=S(),w.attachedTo=N);i=i.concat(R)}}else for(let T of g)if(e.items.find(u=>u.id===T.attachedTo)){const u={...T};u.attachedTo=N||c.id,N&&(u.id=S()),p.push(u)}c.position.x=m.position.x,c.position.y=m.position.y,m.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0,c.metadata[`${a.EXTENSIONID}/metadata_bind`]=JSON.stringify(m),i.push(c),n.push(r)}await t.scene.items.addItems(i),h||await t.scene.items.updateItems(g,r=>{for(let m of r){const c=p.find(D=>D.id===m.id);c&&(m.attachedTo=c.attachedTo)}}),await t.scene.items.deleteItems(n.map(r=>r.id));const P=i.map(r=>r.id);await t.player.select(P)}});async function E(){await t.contextMenu.create({id:a.CONTEXTBINDID,icons:[{icon:"/combine.svg",label:"Bind It",filter:{min:2,max:2,every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}},{icon:"/split.svg",label:"UnBind It",filter:{max:1,every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,operator:"!=",coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}}],async onClick(e,o){if(e.items.length==1){const i=e.items[0],n=JSON.parse(i.metadata[`${a.EXTENSIONID}/metadata_bind`]);n.position.x=i.position.x+i.image.width/2,n.position.y=i.position.y+i.image.height/4,n.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0,await t.scene.items.updateItems(p=>p.id===i.id,p=>{for(let f of p)f.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0}),await t.scene.items.addItems([n])}else{if(!e.items.every(f=>f.layer===e.items[0].layer)){await t.notification.show("Bound items must be from the same Layer.","WARNING");return}const n=e.items[0],p=e.items[1];await t.scene.items.updateItems([e.items[0]],f=>{for(let g=0;g<f.length;g++)f[g].metadata[`${a.EXTENSIONID}/metadata_bind`]=JSON.stringify(p)}),await t.scene.items.deleteItems([p.id]),await t.player.select([n.id])}}})}await E();async function l(){$.onclick=async e=>{const o=e.target;I=!I,await t.room.setMetadata({[`${a.EXTENSIONID}/disableZIndex`]:o.checked})},C.onclick=async e=>{const o=e.target;d=!d,await t.room.setMetadata({[`${a.EXTENSIONID}/disableBinding`]:o.checked})},M.onclick=async e=>{const o=e.target;h=!h,await t.room.setMetadata({[`${a.EXTENSIONID}/attachmentParent`]:o.checked})},await t.scene.items.onChange(async e=>{await t.scene.items.updateItems(e,o=>{if(!I)for(let i of o){if(i.type!=="IMAGE")continue;const n=i.position.y*1e3+i.image.height/6;(i.zIndex!==n&&i.metadata[`${a.EXTENSIONID}/metadata_flip`]!==void 0||i.metadata[`${a.EXTENSIONID}/metadata_flip`]===void 0)&&(i.metadata[`${a.EXTENSIONID}/metadata_flip`]={anchor:n},i.zIndex=n)}})}),await t.scene.items.updateItems(e=>e.layer==="CHARACTER"||e.layer==="MOUNT",e=>{_(e)})}async function _(e){for(let o of e){if(o.type!=="IMAGE")continue;if(o.metadata[`${a.EXTENSIONID}/metadata_flip`]===void 0){const n=o.position.y*1e3+o.image.height/6;o.metadata[`${a.EXTENSIONID}/metadata_flip`]={anchor:n}}const i=o.metadata[`${a.EXTENSIONID}/metadata_flip`];o.zIndex=i.anchor}return e}});
