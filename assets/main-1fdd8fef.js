import{C as a,O as t}from"./constants-6b42fd96.js";function R(r,l){const v=window.matchMedia("(prefers-color-scheme: dark)"),I=v.matches?"dark":"light",u=v.matches?"light":"dark";for(var f=0;f<l.styleSheets.length;f++)for(var e=0;e<l.styleSheets[f].cssRules.length;e++){let i=l.styleSheets[f].cssRules[e];i&&i.media&&i.media.mediaText.includes("prefers-color-scheme")&&(r.mode=="LIGHT"?(i.media.appendMedium(`(prefers-color-scheme: ${I})`),i.media.mediaText.includes(u)&&i.media.deleteMedium(`(prefers-color-scheme: ${u})`)):r.mode=="DARK"&&(i.media.appendMedium(`(prefers-color-scheme: ${u})`),i.media.mediaText.includes(I)&&i.media.deleteMedium(`(prefers-color-scheme: ${I})`)))}}function A(){const r=document.createElement("img");r.id="whatsNewButton",r.setAttribute("class","icon"),r.classList.add("clickable"),r.setAttribute("title","Whats New?"),r.setAttribute("src","/info.svg"),r.onclick=async function(){try{localStorage.setItem(a.VERSION,"true"),r.classList.remove("whats-new-shine")}catch{}await t.modal.open({id:a.EXTENSIONWHATSNEW,url:"/bsWhatsNew.html",height:500,width:350})};try{localStorage.getItem(a.VERSION)!=="true"&&r.classList.add("whats-new-shine")}catch{}return r}document.querySelector("#app").innerHTML=`
  <div>
    <div style="display:flex;"><div id="bannerText"></div><div id="whatsNew"></div></div>
    <h4>Disable Z-Ordering:<input type="checkbox" id="disableZOrder"></h4>
    <h4>Disable Binding for Players:<input type="checkbox" id="disableBinding"></h4>
    <h4>Keep Attachments with Parent:<input type="checkbox" id="keepAttachments"></h4>
  </div>
`;const S=["Fixed Bug with Names Showing","Flip! v1.2","New Attachment Permission"];let g=0,w=!1;const T=document.getElementById("bannerText"),k=document.getElementById("disableZOrder"),x=document.getElementById("disableBinding"),E=document.getElementById("keepAttachments"),M=document.getElementById("whatsNew");M.appendChild(A());function _(){T.style.opacity="0",setTimeout(()=>{X()},2e3)}function X(){g=(g+1)%S.length,T.textContent=S[g],T.style.opacity="1",setTimeout(()=>{_()},1e4)}T.textContent=S[g];X();t.onReady(async()=>{const r=await t.theme.getTheme(),l=await t.room.getMetadata();R(r,document),t.theme.onChange(e=>{R(e,document)}),await t.player.getRole()=="GM"?(x.checked=l[`${a.EXTENSIONID}/disableBinding`]==!0,k.checked=l[`${a.EXTENSIONID}/disableZIndex`]==!0,E.checked=l[`${a.EXTENSIONID}/attachmentParent`]==!0,await t.scene.isReady()&&await u(),await t.scene.onReadyChange(async i=>{i&&await u()})):(await t.action.setHeight(50),document.querySelector("#app").innerHTML="Configuration is GM-Access only.",t.room.onMetadataChange(async e=>{w=e[`${a.EXTENSIONID}/disableBinding`],w&&await t.contextMenu.remove(a.CONTEXTBINDID),w===!1&&await I()})),await t.contextMenu.create({id:a.CONTEXTFLIPID,icons:[{icon:"/flip.svg",label:"Flip It",filter:{every:[{key:"image",value:void 0,operator:"!="}]}}],async onClick(e,i){await t.scene.items.updateItems(e.items,o=>{for(let n of o)n.scale.x=-n.scale.x})}}),await t.contextMenu.create({id:a.CONTEXTFLOPID,icons:[{icon:"/flop.svg",label:"Flip It!!",filter:{every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,operator:"!=",coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}}],async onClick(e,i){let o=[],n=[],m=[];await t.player.deselect(e.items.map(s=>s.id));const N=(await t.scene.items.getItemAttachments(e.items.map(s=>s.id))).filter(s=>!e.items.find(d=>d.id==s.id));for(let s of e.items){const d=s,c=JSON.parse(d.metadata[`${a.EXTENSIONID}/metadata_bind`]);if(E.checked){const h=(await t.scene.items.getItemAttachments([s.id]))?.filter(y=>y.id!==s.id);h?.length>0&&(s.metadata[`${a.EXTENSIONID}/metadata_bind_attachments`]=JSON.stringify(h),n=n.concat(h));const O=c.metadata[`${a.EXTENSIONID}/metadata_bind_attachments`];if(O){const y=d.position.x-c.position.x,C=d.position.y-c.position.y,b=JSON.parse(O);for(const D of b)D.position.x+=y,D.position.y+=C;o=o.concat(b)}}else for(let h of N)if(e.items.find(y=>y.id===h.attachedTo)){const y={...h};y.attachedTo=c.id,m.push(y)}c.position.x=d.position.x,c.position.y=d.position.y,d.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0,c.metadata[`${a.EXTENSIONID}/metadata_bind`]=JSON.stringify(d),o.push(c),n.push(s)}await t.scene.items.addItems(o),E.checked||await t.scene.items.updateItems(N,s=>{for(let d of s){const c=m.find(h=>h.id===d.id);c&&(d.attachedTo=c.attachedTo)}}),await t.scene.items.deleteItems(n.map(s=>s.id));const $=o.map(s=>s.id);await t.player.select($)}});async function I(){await t.contextMenu.create({id:a.CONTEXTBINDID,icons:[{icon:"/combine.svg",label:"Bind It",filter:{min:2,max:2,every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}},{icon:"/split.svg",label:"UnBind It",filter:{max:1,every:[{key:["metadata",`${a.EXTENSIONID}/metadata_bind`],value:void 0,operator:"!=",coordinator:"&&"},{key:"image",value:void 0,operator:"!=",coordinator:"&&"},{key:"layer",value:"GRID",operator:"!=",coordinator:"&&"},{key:"layer",value:"RULER",operator:"!=",coordinator:"&&"},{key:"layer",value:"FOG",operator:"!=",coordinator:"&&"},{key:"layer",value:"POINTER",operator:"!=",coordinator:"&&"},{key:"layer",value:"CONTROL",operator:"!=",coordinator:"&&"},{key:"layer",value:"POPOVER",operator:"!=",coordinator:"&&"}]}}],async onClick(e,i){if(e.items.length==1){const o=e.items[0],n=JSON.parse(o.metadata[`${a.EXTENSIONID}/metadata_bind`]);n.position.x=o.position.x+o.image.width/2,n.position.y=o.position.y+o.image.height/4,n.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0,await t.scene.items.updateItems(m=>m.id===o.id,m=>{for(let p of m)p.metadata[`${a.EXTENSIONID}/metadata_bind`]=void 0}),await t.scene.items.addItems([n])}else{if(!e.items.every(p=>p.layer===e.items[0].layer)){await t.notification.show("Bound items must be from the same Layer.","WARNING");return}const n=e.items[0],m=e.items[1];await t.scene.items.updateItems([e.items[0]],p=>{for(let N=0;N<p.length;N++)p[N].metadata[`${a.EXTENSIONID}/metadata_bind`]=JSON.stringify(m)}),await t.scene.items.deleteItems([m.id]),await t.player.select([n.id])}}})}await I();async function u(){k.addEventListener("click",async e=>{const i=e.target;await t.room.setMetadata({[`${a.EXTENSIONID}/disableZIndex`]:i.checked})},!1),x.addEventListener("click",async e=>{const i=e.target;await t.room.setMetadata({[`${a.EXTENSIONID}/disableBinding`]:i.checked})},!1),E.addEventListener("click",async e=>{const i=e.target;await t.room.setMetadata({[`${a.EXTENSIONID}/attachmentParent`]:i.checked})},!1),await t.scene.items.onChange(async e=>{await t.scene.items.updateItems(e,i=>{if(!k.checked)for(let o of i){if(o.type!=="IMAGE")continue;const n=o.position.y*1e3+o.image.height/6;(o.zIndex!==n&&o.metadata[`${a.EXTENSIONID}/metadata_flip`]!==void 0||o.metadata[`${a.EXTENSIONID}/metadata_flip`]===void 0)&&(o.metadata[`${a.EXTENSIONID}/metadata_flip`]={anchor:n},o.zIndex=n)}})}),await t.scene.items.updateItems(e=>e.layer==="CHARACTER"||e.layer==="MOUNT",e=>{f(e)})}async function f(e){for(let i of e){if(i.type!=="IMAGE")continue;if(i.metadata[`${a.EXTENSIONID}/metadata_flip`]===void 0){const n=i.position.y*1e3+i.image.height/6;i.metadata[`${a.EXTENSIONID}/metadata_flip`]={anchor:n}}const o=i.metadata[`${a.EXTENSIONID}/metadata_flip`];i.zIndex=o.anchor}return e}});
